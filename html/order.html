<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>T1 Cafe - Order Dashboard</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&family=League+Spartan:wght@500;600;700;800&display=swap&subset=vietnamese" rel="stylesheet">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
          crossorigin="anonymous"
          referrerpolicy="no-referrer">
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/order.css" />
  </head>

  <body>
   

    <!-- ===== THANH T√åM KI·∫æM ===== -->
    <div class="container mt-4">
      <div class="row align-items-center mb-3">
        <div class="col-md-6">
          <input
            type="text"
            class="form-control"
            placeholder="üîç T√¨m ƒë∆°n h√†ng theo t√™n ho·∫∑c m√£ ƒë∆°n..."
          />
        </div>
        <div class="col-md-3">
          <select class="form-select">
            <option selected>L·ªçc theo tr·∫°ng th√°i</option>
            <option>ƒêang ch·ªù x·ª≠ l√Ω</option>
            <option>ƒêang pha ch·∫ø</option>
            <option>Ho√†n th√†nh</option>
          </select>
        </div>
        <div class="col-md-3 text-end">
          <a href="../index.html" class="btn btn-outline-secondary me-2">Quay l·∫°i trang ch·ªß</a>
          <button id="logout-btn" class="logout-btn me-2">ƒêƒÉng xu·∫•t</button>
          <button class="btn btn-success px-4">+ Th√™m ƒë∆°n m·ªõi</button>
        </div>
      </div>
    </div>

    <!-- ===== C√ÅC C·ªòT ƒê∆†N H√ÄNG ===== -->
    <div class="container-fluid">
      <div class="row g-4">
        <!-- C·ªòT 1 -->
        <div class="col-md-4">
          <div class="column">
            <div class="status-header">‚è≥ ƒêang ch·ªù x·ª≠ l√Ω</div>
            <div id="pending-list" class="orders-list"></div>
          </div>
        </div>

        <!-- C·ªòT 2 -->
        <div class="col-md-4">
          <div class="column">
            <div class="status-header">‚òï ƒêang pha ch·∫ø</div>
            <div id="brewing-list" class="orders-list"></div>
          </div>
        </div>

        <!-- C·ªòT 3 -->
        <div class="col-md-4">
          <div class="column">
            <div class="status-header">‚úÖ Ho√†n th√†nh</div>
            <div id="done-list" class="orders-list"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <!-- Add Order Modal -->
    <div class="modal fade" id="addOrderModal" tabindex="-1" aria-labelledby="addOrderModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form id="add-order-form">
            <div class="modal-header">
              <h5 class="modal-title" id="addOrderModalLabel">T·∫°o ƒë∆°n m·ªõi</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="order-name" class="form-label">T√™n kh√°ch</label>
                <input type="text" id="order-name" class="form-control" placeholder="V√≠ d·ª•: Linh" required />
              </div>
              <div class="mb-3">
                <label for="order-items" class="form-label">M√≥n (m√¥ t·∫£)</label>
                <textarea id="order-items" class="form-control" rows="3" placeholder="V√≠ d·ª•: 1 Latte, 1 Tr√† s·ªØa"></textarea>
              </div>
              <div class="row g-2">
                <div class="col-6">
                  <label for="order-qty" class="form-label">S·ªë l∆∞·ª£ng m√≥n</label>
                  <input type="number" id="order-qty" class="form-control" min="1" value="1" />
                </div>
                <div class="col-6">
                  <label for="order-note" class="form-label">Ghi ch√∫ (tu·ª≥ ch·ªçn)</label>
                  <input id="order-note" class="form-control" placeholder="√çt ƒë√°, √≠t ƒë∆∞·ªùng..." />
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
              <button type="submit" class="btn btn-success">Th√™m ƒë∆°n</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
      <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteConfirmLabel">X√°c nh·∫≠n</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë∆°n n√†y kh√¥ng? H√†nh ƒë·ªông kh√¥ng th·ªÉ ho√†n t√°c.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">H·ªßy</button>
            <button id="confirm-delete-btn" type="button" class="btn btn-danger btn-sm">X√≥a</button>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Logout button: clear admin session and redirect to login
      (function() {
        const btn = document.getElementById('logout-btn');
        if (!btn) return;
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          try {
            // known session key used by the site
            localStorage.removeItem('coffee_admin_session');
          } catch (err) {
            console.warn('Logout: could not clear session', err);
          }
          // Redirect to login page
          window.location.href = 'login.html';
        });
      })();
    </script>
    <script>
      // Order management: create, move, persist
      (function() {
        const STORAGE_KEY = 't1_orders_v1';

        function uid() {
          return 'o_' + Math.random().toString(36).slice(2,9);
        }

        function nowLabel() {
          const d = new Date();
          return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function loadOrders() {
          try {
            return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
          } catch (e) { return []; }
        }

        function saveOrders(list) {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        }

        function render() {
          const orders = loadOrders();
          const pending = document.getElementById('pending-list');
          const brewing = document.getElementById('brewing-list');
          const done = document.getElementById('done-list');
          [pending, brewing, done].forEach(el => el.innerHTML = '');

          orders.forEach(o => {
            const card = document.createElement('div');
            card.className = 'order-card ' + (o.status === 'brewing' ? 'border-start border-primary' : '') + (o.status === 'done' ? 'border-start border-success' : '');
            // prepare enter animation
            card.classList.add('enter');
            card.dataset.id = o.id;

            const h = document.createElement('h6');
            h.textContent = `ƒê∆°n ${o.id.replace('o_','')} - ${o.name}`;
            const small = document.createElement('small');
            small.textContent = o.time;
            const p = document.createElement('p');
            p.textContent = o.items;

            const actions = document.createElement('div');
            actions.style.marginTop = '8px';

            if (o.status === 'pending') {
              const start = document.createElement('button');
              start.className = 'btn btn-sm btn-warning';
              start.textContent = 'B·∫Øt ƒë·∫ßu pha';
              start.addEventListener('click', () => updateStatus(o.id, 'brewing'));
              actions.appendChild(start);
            } else if (o.status === 'brewing') {
              const complete = document.createElement('button');
              complete.className = 'btn btn-sm btn-primary';
              complete.textContent = 'Ho√†n th√†nh';
              complete.addEventListener('click', () => updateStatus(o.id, 'done'));
              actions.appendChild(complete);
            } else {
              const served = document.createElement('button');
              served.className = 'btn btn-sm btn-success me-2';
              served.textContent = 'ƒê√£ ph·ª•c v·ª•';
              served.disabled = true;
              actions.appendChild(served);

              // delete button for completed orders
              const del = document.createElement('button');
              del.className = 'btn btn-sm btn-outline-danger';
              del.textContent = 'X√≥a';
              del.addEventListener('click', () => {
                // open delete confirmation modal
                const deleteModalEl = document.getElementById('deleteConfirmModal');
                const deleteModal = deleteModalEl ? new bootstrap.Modal(deleteModalEl) : null;
                if (deleteModal) {
                  // store the id to delete on confirm
                  deleteModalEl.dataset.toDelete = o.id;
                  deleteModal.show();
                } else {
                  if (confirm('X√°c nh·∫≠n x√≥a ƒë∆°n n√†y?')) deleteOrder(o.id);
                }
              });
              actions.appendChild(del);
            }

            card.appendChild(h);
            card.appendChild(small);
            card.appendChild(p);
            card.appendChild(actions);

            // make draggable
            card.setAttribute('draggable', 'true');
            card.addEventListener('dragstart', (ev) => {
              ev.dataTransfer.setData('text/plain', o.id);
              card.classList.add('dragging');
              // small timeout to allow CSS transitions
              setTimeout(() => card.classList.add('hide-during-drag'), 20);
            });
            card.addEventListener('dragend', () => {
              card.classList.remove('dragging');
              card.classList.remove('hide-during-drag');
            });

            if (o.status === 'pending' && pending) pending.appendChild(card);
            if (o.status === 'brewing' && brewing) brewing.appendChild(card);
            if (o.status === 'done' && done) done.appendChild(card);

            // trigger enter -> show
            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                card.classList.add('show');
                card.classList.remove('enter');
              });
            });
          });
        }

        // setup drop handlers for lists
        function setupDropZones() {
          const mapping = [
            { el: document.getElementById('pending-list'), status: 'pending' },
            { el: document.getElementById('brewing-list'), status: 'brewing' },
            { el: document.getElementById('done-list'), status: 'done' }
          ];

          mapping.forEach(zone => {
            const el = zone.el;
            if (!el) return;
            el.addEventListener('dragover', (e) => {
              e.preventDefault();
              el.classList.add('dragover');
            });
            el.addEventListener('dragleave', () => el.classList.remove('dragover'));
            el.addEventListener('drop', (e) => {
              e.preventDefault();
              el.classList.remove('dragover');
              const id = e.dataTransfer.getData('text/plain');
              if (!id) return;
              // update status and re-render
              updateStatus(id, zone.status);
            });
          });
        }

        // call setup after DOM ready so lists exist
        document.addEventListener('DOMContentLoaded', setupDropZones);

        function updateStatus(id, to) {
          const list = loadOrders();
          const it = list.find(x => x.id === id);
          if (!it) return;
          // add leaving class to card element to animate
          const cardEl = document.querySelector(`.order-card[data-id="${id}"]`);
          if (cardEl) {
            cardEl.classList.add('leaving');
            setTimeout(() => {
              it.status = to;
              saveOrders(list);
              render();
            }, 240);
          } else {
            it.status = to;
            saveOrders(list);
            render();
          }
        }

        function deleteOrder(id) {
          let list = loadOrders();
          // animate leave on the card then remove
          const cardEl = document.querySelector(`.order-card[data-id="${id}"]`);
          if (cardEl) {
            cardEl.classList.add('leaving');
            setTimeout(() => {
              list = list.filter(x => x.id !== id);
              saveOrders(list);
              render();
            }, 260);
          } else {
            list = list.filter(x => x.id !== id);
            saveOrders(list);
            render();
          }
        }

        // delete modal confirm handler
        document.addEventListener('DOMContentLoaded', () => {
          const delModalEl = document.getElementById('deleteConfirmModal');
          const confirmBtn = document.getElementById('confirm-delete-btn');
          if (confirmBtn && delModalEl) {
            confirmBtn.addEventListener('click', () => {
              const id = delModalEl.dataset.toDelete;
              if (id) deleteOrder(id);
              const m = bootstrap.Modal.getInstance(delModalEl);
              m?.hide();
            });
          }
        });

        function addOrder(name, items) {
          const list = loadOrders();
          const o = { id: uid(), name: name || 'Kh√°ch', items: items || '', time: nowLabel(), status: 'pending' };
          list.unshift(o);
          saveOrders(list);
          render();
        }

        // wire add button to open modal and handle form submit
        document.addEventListener('DOMContentLoaded', () => {
          render();
          const addBtn = document.querySelector('.btn.btn-success');
          const addModalEl = document.getElementById('addOrderModal');
          const addModal = addModalEl ? new bootstrap.Modal(addModalEl) : null;
          const form = document.getElementById('add-order-form');

          if (addBtn && addModal) {
            addBtn.addEventListener('click', (e) => {
              e.preventDefault();
              addModal.show();
            });
          }

          if (form) {
            form.addEventListener('submit', function(ev) {
              ev.preventDefault();
              const name = document.getElementById('order-name').value.trim() || 'Kh√°ch';
              const items = document.getElementById('order-items').value.trim() || 'Ch∆∞a c√≥ m√≥n';
              const qty = Number(document.getElementById('order-qty').value || 1);
              const note = document.getElementById('order-note').value.trim();
              const itemsText = qty > 1 ? `${qty} x ${items}` : items + (note ? ' ‚Äî ' + note : '');
              addOrder(name, itemsText);
              form.reset();
              addModal.hide();
            });
          }
        });
      })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
